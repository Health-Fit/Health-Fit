<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heemin.ws.model.dao.ExerciseVideoDao">

    <resultMap id="ExerciseVideoResultMap" type="ExerciseVideo">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="url" column="url"/>
        <collection property="categories" ofType="ExerciseCategory">
            <id property="id" column="category_id"/>
            <result property="name" column="category_name"/>
            <result property="categoryType" column="category_type"/>
        </collection>
    </resultMap>

    <select id="selectExample" resultMap="ExerciseVideoResultMap">
        SELECT
        ec.id AS category_id,
        ec.name AS category_name,
        ec.category_type AS category_type,
        ev.id AS id,
        ev.title AS title,
        ev.url AS url,
        FROM
        exercise_category ec
        JOIN
        exercise_video_category evc ON ec.id = evc.exercise_category_id
        JOIN
        exercise_video ev ON evc.exercise_video_id = ev.id
        WHERE
        ev.deleted = false
        AND ev.view_cnt = (
        SELECT MAX(ev2.view_cnt)
        FROM exercise_video_category evc2
        JOIN exercise_video ev2 ON evc2.exercise_video_id = ev2.id
        WHERE evc2.exercise_category_id = ec.id AND ev2.deleted = false
        )
    </select>


</mapper>
